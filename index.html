<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æŸ¥ ğŸ“± ä¼šå‘è´¢---æ‰‹æœºå·åŒ¹é…æå–å·¥å…·</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body{font-family:sans-serif;max-width:1000px;margin:20px auto;padding:0 15px;}
    h1{margin-bottom:20px;}
    .tabs{display:flex;gap:10px;margin-bottom:20px;}
    .tab{flex:1;text-align:center;padding:10px;background:#f1f1f1;border-radius:6px;cursor:pointer;font-weight:bold;}
    .tab.active{background:#1a73e8;color:#fff;}
    .card{border:1px solid #ddd;border-radius:8px;padding:16px;}
    .btn{padding:8px 14px;background:#1a73e8;color:#fff;border:none;border-radius:6px;cursor:pointer;margin:6px 6px 6px 0;display:inline-block;text-decoration:none;}
    .btn.disabled{opacity:.5;pointer-events:none;}
    textarea{width:100%;height:150px;margin-top:10px;}
    .summary{margin-top:10px;font-weight:bold;}
    .dropzone{border:2px dashed #ccc;padding:20px;text-align:center;margin:10px 0;cursor:pointer;background:#fafafa;}
    .dropzone.dragover{background:#e3f2fd;border-color:#2196f3;}
    .hidden{display:none;}
  </style>
</head>
<body>
  <h1>ğŸ“± ä¼šå‘è´¢---æ‰‹æœºå·é€šç”¨åŒ¹é…æå–å·¥å…·</h1>

  <div class="tabs">
    <div class="tab active" onclick="showTab('matchPart', this)">é€šç”¨åŒ¹é…</div>
    <div class="tab" onclick="showTab('segmentPart', this)">å·æ®µç­›é€‰</div>
  </div>

  <!-- é€šç”¨åŒ¹é…åŒº -->
  <div id="matchPart" class="card">
    <h2>é€šç”¨åŒ¹é…</h2>
    <div class="dropzone" id="dropA">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼  æ–‡ä»¶Aï¼ˆæ”¯æŒTXT/CSV/XLSXï¼Œå¤šæ–‡ä»¶ï¼‰</div>
    <input type="file" id="fileA" style="display:none" multiple accept=".txt,.csv,.xlsx">
    <div class="dropzone" id="dropB">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼  æ–‡ä»¶Bï¼ˆæ”¯æŒTXT/CSV/XLSXï¼Œå¤šæ–‡ä»¶ï¼‰</div>
    <input type="file" id="fileB" style="display:none" multiple accept=".txt,.csv,.xlsx">

    <div>
      åŒ¹é…æ–¹å¼ï¼š
      <select id="matchType">
        <option value="exact">ç²¾ç¡®åŒ¹é…</option>
        <option value="fuzzy">æ¨¡ç³ŠåŒ¹é…ï¼ˆå‰10ä½ï¼‰</option>
      </select>
      <button class="btn" onclick="universalMatch()">å¼€å§‹åŒ¹é…</button>
      <button class="btn" onclick="downloadMatched()">ä¸‹è½½åŒ¹é…ç»“æœ</button>
      <button class="btn" onclick="downloadUnmatched()">ä¸‹è½½æœªåŒ¹é…æ•°æ®</button>
    </div>

    <div id="summary" class="summary">ç­‰å¾…åŒ¹é…...</div>

    <h3>âœ… åŒ¹é…ç»“æœ</h3>
    <textarea id="matchedBox">--</textarea>
    <h3>âŒ æœªåŒ¹é…ç»“æœ</h3>
    <textarea id="unmatchedBox">--</textarea>
  </div>

  <!-- å·æ®µç­›é€‰åŒº -->
  <div id="segmentPart" class="card hidden">
    <h2>å·æ®µç­›é€‰åŠŸèƒ½</h2>
    <p>ä¸Šä¼ ä¸€ä¸ª TXT æ–‡ä»¶ï¼Œå¹¶è¾“å…¥è¦ç­›é€‰çš„å·æ®µï¼Œä¾‹å¦‚ <b>255</b>ï¼š</p>
    <input id="segmentFile" type="file" accept=".txt,.csv" />
    <input id="segmentInput" type="text" placeholder="è¾“å…¥å·æ®µ (å¦‚ 255)" />
    <div>
      <button id="segmentBtn" class="btn">ç­›é€‰å·æ®µ</button>
      <a id="downloadSegBtn" class="btn disabled" href="#">ä¸‹è½½å·æ®µç»“æœ</a>
      <a id="downloadRemainBtn" class="btn disabled" href="#">ä¸‹è½½å‰©ä½™å·ç </a>
    </div>
    <p id="segmentInfo"></p>
  </div>

  <script>
    // ==== é€šç”¨å‡½æ•° ====
    function showTab(id, el){
      document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
    }
    function cleanPhone(v){return String(v||'').replace(/\D+/g,'');}
    function detectDelimiter(text){
      const comma=(text.match(/,/g)||[]).length;
      const tab=(text.match(/\t/g)||[]).length;
      return tab>comma ? "\t" : ",";
    }
    function readAsText(file){
      return new Promise((res,rej)=>{
        const fr=new FileReader();
        fr.onload=()=>res(fr.result);
        fr.onerror=rej;
        fr.readAsText(file,'utf-8');
      });
    }

    // ==== æ‹–æ‹½è®¾ç½® ====
    function setupDropzone(dropId,inputId){
      const drop=document.getElementById(dropId);
      const input=document.getElementById(inputId);
      drop.addEventListener('click',()=>input.click());
      drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('dragover');});
      drop.addEventListener('dragleave',()=>drop.classList.remove('dragover'));
      drop.addEventListener('drop',e=>{
        e.preventDefault();drop.classList.remove('dragover');
        input.files=e.dataTransfer.files;
        drop.textContent=`å·²ä¸Šä¼ ï¼š${[...input.files].map(f=>f.name).join('ï¼Œ')}`;
      });
      input.addEventListener('change',()=>{
        if(input.files.length>0) drop.textContent=`å·²ä¸Šä¼ ï¼š${[...input.files].map(f=>f.name).join('ï¼Œ')}`;
      });
    }
    setupDropzone('dropA','fileA');
    setupDropzone('dropB','fileB');

    let matchedLines=[], unmatchedLines=[];

    // ==== é€šç”¨åŒ¹é…é€»è¾‘ ====
    async function universalMatch(){
      matchedLines=[];unmatchedLines=[];
      document.getElementById('summary').textContent='æ­£åœ¨è‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»å‹å¹¶åŒ¹é…...';
      document.getElementById('matchedBox').value='';document.getElementById('unmatchedBox').value='';
      const matchType=document.getElementById('matchType').value;
      const filesA=[...document.getElementById('fileA').files];
      const filesB=[...document.getElementById('fileB').files];
      if(filesA.length===0||filesB.length===0){alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶Aå’Œæ–‡ä»¶B');return;}

      // è‡ªåŠ¨åˆ¤æ–­ç±»å‹
      const sampleText=await readAsText(filesA[0]);
      const firstLine=sampleText.split(/\r?\n/)[0];
      const firstCell=cleanPhone(firstLine.split(/,|\t/)[0]||"");
      const isPhoneFile=/^\d{10,13}$/.test(firstCell);

      if(isPhoneFile){
        await matchMode_FileVsFile(filesA,filesB,matchType);
      }else{
        await matchMode_TableVsTxt(filesA,filesB);
      }
    }

    // ==== æ¨¡å¼1ï¼šæ–‡ä»¶1 vs æ–‡ä»¶2 ====
    async function matchMode_FileVsFile(filesA,filesB,matchType){
      let phonesA=new Set(), allB=[];
      for(const f of filesA){
        const text=await readAsText(f);
        text.split(/\r?\n/).map(l=>l.trim().split(',')[0]).filter(x=>x).forEach(x=>{
          phonesA.add(matchType==='fuzzy'?x.slice(0,10):x);
        });
      }
      for(const f of filesB){
        const text=await readAsText(f);
        const lines=text.split(/\r?\n/).filter(l=>l.trim());
        lines.forEach(line=>{
          const key=matchType==='fuzzy'?line.split(',')[0].slice(0,10):line.split(',')[0];
          if(phonesA.has(key)) matchedLines.push(line);
          else unmatchedLines.push(line);
        });
      }
      document.getElementById('summary').textContent=`[æ–‡ä»¶æ¨¡å¼] åŒ¹é… ${matchedLines.length} æ¡ï¼ŒæœªåŒ¹é… ${unmatchedLines.length} æ¡`;
      document.getElementById('matchedBox').value=matchedLines.join("\n")||"--";
      document.getElementById('unmatchedBox').value=unmatchedLines.join("\n")||"--";
    }

    // ==== æ¨¡å¼2ï¼šCSV/XLSX vs TXT ====
    async function matchMode_TableVsTxt(filesA,filesB){
      let phoneSet=new Set(), txtRows=[], duplicateList=[];
      // Aç»„æ–‡ä»¶ï¼ˆå”®åç±»ï¼‰
      for(const file of filesA){
        const ext=file.name.split('.').pop().toLowerCase();
        if(ext==="xlsx"){
          const data=await file.arrayBuffer();
          const wb=XLSX.read(data,{type:"array"});
          const sheet=wb.Sheets[wb.SheetNames[0]];
          const json=XLSX.utils.sheet_to_json(sheet,{header:1});
          for(let i=1;i<json.length;i++){
            const ph=cleanPhone(json[i][0]);
            if(ph){
              if(phoneSet.has(ph)) duplicateList.push(ph);
              phoneSet.add(ph);
            }
          }
        }else{
          const text=await readAsText(file);
          const parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
          const headers=parsed.meta.fields;
          const phoneCol=headers.find(h=>h.includes("æ‰‹æœºå·")||h.toLowerCase().includes("phone"))||headers[0];
          parsed.data.forEach(row=>{
            const ph=cleanPhone(row[phoneCol]);
            if(ph){
              if(phoneSet.has(ph)) duplicateList.push(ph);
              phoneSet.add(ph);
            }
          });
        }
      }

      // Bç»„æ–‡ä»¶ï¼ˆTXTæºï¼‰
      for(const file of filesB){
        const text=await readAsText(file);
        const delim=detectDelimiter(text.slice(0,2000));
        const parsed=Papa.parse(text,{header:false,delimiter:delim,skipEmptyLines:true});
        parsed.data.forEach(r=>txtRows.push(r));
      }

      matchedLines=txtRows.filter(r=>phoneSet.has(cleanPhone(r[0]))).map(r=>r.join(","));
      unmatchedLines=txtRows.filter(r=>!phoneSet.has(cleanPhone(r[0]))).map(r=>r.join(","));

      document.getElementById('summary').textContent=`[è¡¨æ ¼æ¨¡å¼] åŒ¹é… ${matchedLines.length} æ¡ï¼ŒæœªåŒ¹é… ${unmatchedLines.length} æ¡ï¼Œé‡å¤æ‰‹æœºå· ${duplicateList.length}`;
      document.getElementById('matchedBox').value=matchedLines.slice(0,2000).join("\n")||"--";
      document.getElementById('unmatchedBox').value=unmatchedLines.slice(0,2000).join("\n")||"--";
    }

    // ==== å¯¼å‡º ====
    function downloadMatched(){
      if(matchedLines.length===0){alert('æ— åŒ¹é…ç»“æœ');return;}
      const blob=new Blob([matchedLines.join('\n')],{type:'text/plain'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download='åŒ¹é…ç»“æœ.txt';a.click();URL.revokeObjectURL(a.href);
    }
    function downloadUnmatched(){
      if(unmatchedLines.length===0){alert('æ— æœªåŒ¹é…æ•°æ®');return;}
      const blob=new Blob([unmatchedLines.join('\n')],{type:'text/plain'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download='æœªåŒ¹é…æ•°æ®.txt';a.click();URL.revokeObjectURL(a.href);
    }

    // ==== å·æ®µç­›é€‰ ====
    segmentBtn.addEventListener('click',async()=>{
      if(!segmentFile.files?.length){alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªTXTæ–‡ä»¶');return;}
      const text=await readAsText(segmentFile.files[0]);
      const delim=detectDelimiter(text.slice(0,2000));
      const parsed=Papa.parse(text,{header:false,delimiter:delim,skipEmptyLines:true});
      const rows=parsed.data;
      const seg=segmentInput.value.trim();
      if(!seg){alert('è¯·è¾“å…¥å·æ®µ');return;}
      let matched=[],remain=[];
      rows.forEach(r=>{
        const ph=cleanPhone(r[0]);
        if(ph.startsWith(seg)) matched.push(r);
        else remain.push(r);
      });
      const blob1=new Blob([matched.map(r=>r.join(",")).join("\n")],{type:'text/plain'});
      const blob2=new Blob([remain.map(r=>r.join(",")).join("\n")],{type:'text/plain'});
      downloadSegBtn.href=URL.createObjectURL(blob1);
      downloadSegBtn.download=`segment_${seg}_${matched.length}.txt`;
      downloadSegBtn.textContent=`ä¸‹è½½å·æ®µç»“æœ (${matched.length} è¡Œ)`;
      downloadSegBtn.classList.remove('disabled');
      downloadRemainBtn.href=URL.createObjectURL(blob2);
      downloadRemainBtn.download=`remain_except_${seg}_${remain.length}.txt`;
      downloadRemainBtn.textContent=`ä¸‹è½½å‰©ä½™å·ç  (${remain.length} è¡Œ)`;
      downloadRemainBtn.classList.remove('disabled');
      segmentInfo.textContent=`ç­›é€‰å®Œæˆï¼šå·æ®µ ${seg} â†’ ${matched.length} è¡Œï¼›å‰©ä½™ ${remain.length} è¡Œ`;
    });
  </script>
</body>
</html>
